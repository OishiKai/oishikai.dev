---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const products = await getCollection('products');
  return products.map((product) => ({
    params: { slug: product.id },
    props: { product },
  }));
};

const { product } = Astro.props;
const milestones = product.data.milestones;
---

<BaseLayout title={product.data.title} description={product.data.description}>
  <div class="mx-auto max-w-4xl px-4 py-12">
    <div class="mb-6">
      <a href="/products" class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Products
      </a>
    </div>

    <!-- App Card -->
    <section class="rounded-xl border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-surface-dark-secondary sm:p-8">
      <div class="flex flex-col gap-6 sm:flex-row sm:items-start">
        <div class={`flex h-24 w-24 shrink-0 items-center justify-center rounded-2xl bg-gradient-to-br ${product.data.iconGradient} text-3xl font-bold text-white shadow-lg`}>
          {product.data.iconLabel}
        </div>
        <div class="flex-1">
          <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{product.data.title}</h1>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
            {product.data.platform} &middot; {product.data.price}
            {product.data.rating && <> &middot; 評価 {product.data.rating}</>}
          </p>
          <p class="mt-3 text-gray-600 dark:text-gray-400">{product.data.description}</p>

          <div class="mt-4 flex flex-wrap gap-1.5">
            {product.data.techStack.map((tech: string) => (
              <span class="rounded-full bg-primary-50 px-2.5 py-0.5 text-xs font-medium text-primary-700 dark:bg-primary-900/30 dark:text-primary-300">
                {tech}
              </span>
            ))}
          </div>

          {product.data.storeUrl && (
            <div class="mt-5">
              <a
                href={product.data.storeUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 rounded-lg bg-gray-900 px-5 py-2.5 text-sm font-medium text-white transition-colors hover:bg-gray-800 dark:bg-white dark:text-gray-900 dark:hover:bg-gray-100"
              >
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                </svg>
                App Store で見る
              </a>
            </div>
          )}
        </div>
      </div>
    </section>

    <!-- Milestones -->
    {milestones.length > 0 && (
      <section class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Milestones</h2>
        <div class="relative mt-6 border-l-2 border-primary-200 dark:border-primary-800">
          {milestones.slice().reverse().map((item: { version: string; date: string; description: string }, i: number) => (
            <div class:list={['relative pl-6', i > 0 && 'mt-6']}>
              <div class="absolute -left-[9px] top-1 h-4 w-4 rounded-full border-2 border-primary-500 bg-white dark:bg-surface-dark"></div>
              <div class="flex items-center gap-2">
                <span class="rounded-full bg-primary-100 px-2.5 py-0.5 text-xs font-semibold text-primary-700 dark:bg-primary-900/30 dark:text-primary-300">
                  {item.version}
                </span>
                <span class="text-sm text-gray-500 dark:text-gray-400">{item.date}</span>
              </div>
              <p class="mt-1 text-gray-600 dark:text-gray-400">{item.description}</p>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Contact -->
    <section class="mt-12">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Contact</h2>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        このアプリに関するお問い合わせ、不具合報告、機能リクエストはこちらからどうぞ。
      </p>
      <form
        id="contact-form"
        class="mt-6 space-y-4"
        data-product={product.data.shortName}
      >
        <div class="max-w-sm">
          <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">カテゴリ</label>
          <select
            id="category"
            name="category"
            class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm text-gray-900 transition-colors focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-gray-600 dark:bg-surface-dark dark:text-white dark:focus:border-primary-400 dark:focus:ring-primary-400"
          >
            <option value="bug">不具合報告</option>
            <option value="feature">機能リクエスト</option>
            <option value="question">質問</option>
            <option value="other">その他</option>
          </select>
        </div>
        <div class="max-w-sm">
          <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ニックネーム</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm text-gray-900 transition-colors focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-gray-600 dark:bg-surface-dark dark:text-white dark:focus:border-primary-400 dark:focus:ring-primary-400"
          />
        </div>
        <div class="max-w-sm">
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">メールアドレス</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm text-gray-900 transition-colors focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-gray-600 dark:bg-surface-dark dark:text-white dark:focus:border-primary-400 dark:focus:ring-primary-400"
          />
        </div>
        <div>
          <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300">メッセージ</label>
          <textarea
            id="message"
            name="message"
            rows="5"
            required
            class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm text-gray-900 transition-colors focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:border-gray-600 dark:bg-surface-dark dark:text-white dark:focus:border-primary-400 dark:focus:ring-primary-400"
          ></textarea>
        </div>
        <div>
          <button
            type="submit"
            id="submit-btn"
            class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-6 py-2.5 text-sm font-medium text-white transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:opacity-70 dark:focus:ring-offset-surface-dark"
          >
            <svg id="submit-spinner" class="hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="submit-text">送信する</span>
          </button>
        </div>
        <p id="form-status" class="hidden text-sm"></p>
      </form>
    </section>
  </div>
</BaseLayout>

<script>
  function initContactForm() {
    const form = document.getElementById('contact-form') as HTMLFormElement | null;
    const status = document.getElementById('form-status');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
    const submitSpinner = document.getElementById('submit-spinner');
    const submitText = document.getElementById('submit-text');
    if (!form || !status || !submitBtn || !submitSpinner || !submitText) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitSpinner.classList.remove('hidden');
      submitText.textContent = '送信中...';
      status.className = 'hidden';

      const data = new FormData(form);
      const payload = {
        product: form.dataset.product,
        name: data.get('name'),
        email: data.get('email'),
        category: data.get('category'),
        message: data.get('message'),
      };

      try {
        const res = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const result = await res.json();

        if (res.ok) {
          status.textContent = '送信しました。お問い合わせありがとうございます。';
          status.className = 'text-sm text-green-600 dark:text-green-400';
          form.reset();
        } else {
          status.textContent = result.error || '送信に失敗しました。';
          status.className = 'text-sm text-red-600 dark:text-red-400';
        }
      } catch {
        status.textContent = 'ネットワークエラーが発生しました。';
        status.className = 'text-sm text-red-600 dark:text-red-400';
      } finally {
        submitBtn.disabled = false;
        submitSpinner.classList.add('hidden');
        submitText.textContent = '送信する';
      }
    });
  }

  initContactForm();
  document.addEventListener('astro:after-swap', initContactForm);
</script>
